{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RUNPOLLS | Election Results</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'elections/admin-results.css' %}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo-container">
        <img class="logo" src="images/Logo.png" alt="RunPolls" />
        <i class="bi bi-x-lg" id="close"></i>
      </div>

      <div class="profile-container">
        <div class="profile-image-container" id="sidebarProfileContainer">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='70' height='70' viewBox='0 0 70 70'%3E%3Ccircle cx='35' cy='35' r='35' fill='%23e9ecef'/%3E%3Cpath d='M35 20c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 28c-6.6 0-12.4-3.4-15.8-8.6 1.8-3.2 5.2-5.4 9.1-5.4h13.4c3.9 0 7.3 2.2 9.1 5.4-3.4 5.2-9.2 8.6-15.8 8.6z' fill='%236c757d'/%3E%3C/svg%3E"
            class="profile-image"
            id="userProfileImage"
          />
        </div>
        <div class="profile-name" id="userProfileName">Isaiah Durojaiye</div>
        <div class="profile-role" id="userProfileRole">
          System Administrator
        </div>
      </div>

      <ul class="sidebar-nav list-unstyled">
        <li class="nav-item">
          <a href="{% url 'admin-dashboard' %}" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'admin-election' %}" class="nav-link">
            <i class="fas fa-vote-yea"></i>
            <span>Elections</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'admin-voters' %}" class="nav-link">
            <i class="fas fa-users"></i>
            <span>Voters</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'admin-candidate' %}" class="nav-link">
            <i class="fas fa-user-tie"></i>
            <span>Candidates</span>
          </a>
        </li>
        <li class="nav-item active">
          <a href="{% url 'admin-results' %}" class="nav-link active">
            <i class="fas fa-chart-bar"></i>
            <span>Results</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'login_page' %}" class="nav-link">
            <i class="fas fa-sign-out-alt"></i>
            <span>Log out</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="top-navbar">
        <button class="toggle-sidebar" id="toggleSidebar">
          <i class="bi bi-list"></i>
        </button>

        <div class="search-bar position-relative">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search elections..."
            id="globalSearch"
          />
        </div>

        <div class="user-actions">
          <div class="action-icon">
            <a href="{% url 'admin-notification' %}"><i class="bi bi-bell"></i></a>
          </div>
          <div class="navbar-user-container" id="navbarUserContainer">
            <img
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='70' height='70' viewBox='0 0 70 70'%3E%3Ccircle cx='35' cy='35' r='35' fill='%23e9ecef'/%3E%3Cpath d='M35 20c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 28c-6.6 0-12.4-3.4-15.8-8.6 1.8-3.2 5.2-5.4 9.1-5.4h13.4c3.9 0 7.3 2.2 9.1 5.4-3.4 5.2-9.2 8.6-15.8 8.6z' fill='%236c757d'/%3E%3C/svg%3E"
              class="user-avatar"
              id="navbarUserImage"
            />
            <div class="status-indicator"></div>
          </div>
        </div>
      </div>

      <div class="dashboard-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h3>Election Results</h3>
            <p class="text-muted">
              View and manage election results in real-time
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <button class="btn btn-outline-primary me-2" id="exportResults">
              <i class="fas fa-download me-1"></i> Export Results
            </button>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-container">
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Election Status</label>
            <select class="form-select" id="statusFilter">
              <option value="all">All Elections</option>
              <option value="ongoing">Ongoing Elections</option>
              <option value="completed">Completed Elections</option>
              <option value="upcoming">Upcoming Elections</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Election Type</label>
            <select class="form-select" id="typeFilter">
              <option value="">All Types</option>
              <option value="student">Student Council</option>
              <option value="department">Departmental</option>
              <option value="faculty">Faculty</option>
              <option value="general">General Election</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Timeframe</label>
            <select class="form-select" id="timeFilter">
              <option value="all">All Time</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 3 months</option>
              <option value="365">Last year</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Visibility</label>
            <select class="form-select" id="visibilityFilter">
              <option value="all">All Results</option>
              <option value="public">Public Results</option>
              <option value="private">Private Results</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Live Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalVotes">0</div>
          <div class="stat-label">Total Votes Cast</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="turnoutRate">0%</div>
          <div class="stat-label">Voter Turnout</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeElections">0</div>
          <div class="stat-label">Active Elections</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completedElections">0</div>
          <div class="stat-label">Completed Elections</div>
        </div>
      </div>

      <!-- Election Selection -->
      <div class="results-card">
        <div class="card-header p-3">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="mb-0">Select Election to View Results</h5>
            </div>
            <div class="col-auto">
              <span
                class="live-indicator"
                id="liveIndicator"
                style="display: none"
              >
                <span class="live-dot"></span>
                LIVE
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <select class="form-select" id="electionSelect">
                <option value="">Select an election...</option>
              </select>
            </div>
            <div class="col-md-4">
              <div class="btn-group w-100">
                <button class="btn btn-outline-secondary" id="refreshResults">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-primary" id="toggleAutoRefresh">
                  <i class="fas fa-pause"></i> Auto-refresh
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Display -->
      <div class="results-card" id="resultsDisplay" style="display: none">
        <div class="card-header p-3">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="mb-0" id="electionTitle">Election Results</h5>
              <small class="text-muted" id="lastUpdated"
                >Last updated: Just now</small
              >
            </div>
            <div class="col-auto">
              <div class="btn-group view-toggle">
                <button class="btn btn-outline-secondary active" id="tableView">
                  <i class="fas fa-table"></i> Table
                </button>
                <button class="btn btn-outline-secondary" id="chartView">
                  <i class="fas fa-chart-pie"></i> Pie Chart
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Election Progress -->
          <div class="row mb-4" id="electionProgress">
            <div class="col-md-6 election-progress">
              <h6>Voting Progress</h6>
              <div class="progress-custom mb-2">
                <div
                  class="progress-bar-custom"
                  id="progressBar"
                  style="width: 0%"
                ></div>
              </div>
              <small class="text-muted" id="progressText"
                >0 of 0 eligible voters (0%)</small
              >
            </div>
            <div class="col-md-6 status-progress">
              <h6>Status</h6>
              <div class="d-flex align-items-center">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <span id="electionStatus">No election selected</span>
              </div>
            </div>
          </div>

          <!-- Table View -->
          <div id="tableViewContainer">
            <div class="table-responsive">
              <table class="table" id="resultsTable">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Candidate</th>
                    <th>Votes</th>
                    <th>Percentage</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="resultsTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                      Select an election to view results
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Chart View -->
          <div id="chartViewContainer" style="display: none">
            <div class="chart-container">
              <canvas id="resultsChart"></canvas>
            </div>
            <div class="mt-3" id="chartLegend">
              <!-- Chart legend will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

        <div class="elections-container"></div>
        <div class="results-container"></div>
    </div>

    <script src="{% static 'accounts/js/utils.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Sample election data
      const electionData = {
        el1: {
          name: "President Student Council 2024",
          status: "ongoing",
          type: "student",
          candidates: [
            {
              name: "Sarah Johnson",
              votes: 487,
              faculty: "Engineering",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Michael Chen",
              votes: 423,
              faculty: "Business",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Emily Rodriguez",
              votes: 335,
              faculty: "Arts",
              image: "/api/placeholder/40/40",
            },
          ],
          eligibleVoters: 1830,
          startDate: "2024-01-15",
          endDate: "2024-01-20",
          visibility: "public",
        },
        el2: {
          name: "Vice President Student Council 2024",
          status: "ongoing",
          type: "student",
          candidates: [
            {
              name: "David Kim",
              votes: 298,
              faculty: "Science",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Lisa Wang",
              votes: 256,
              faculty: "Engineering",
              image: "/api/placeholder/40/40",
            },
            {
              name: "James Brown",
              votes: 150,
              faculty: "Arts",
              image: "/api/placeholder/40/40",
            },
          ],
          eligibleVoters: 1830,
          startDate: "2024-01-15",
          endDate: "2024-01-20",
          visibility: "public",
        },
        el3: {
          name: "Computer Science Department Head",
          status: "upcoming",
          type: "department",
          candidates: [
            {
              name: "Dr. Alan Turing",
              votes: 0,
              faculty: "Computer Science",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Prof. Ada Lovelace",
              votes: 0,
              faculty: "Computer Science",
              image: "/api/placeholder/40/40",
            },
          ],
          eligibleVoters: 245,
          startDate: "2024-02-01",
          endDate: "2024-02-05",
          visibility: "public",
        },
        el4: {
          name: "Faculty of Engineering Representative",
          status: "completed",
          type: "faculty",
          candidates: [
            {
              name: "Dr. Ahmed Hassan",
              votes: 156,
              faculty: "Engineering",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Prof. Maria Santos",
              votes: 132,
              faculty: "Engineering",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Dr. John Smith",
              votes: 33,
              faculty: "Engineering",
              image: "/api/placeholder/40/40",
            },
          ],
          eligibleVoters: 380,
          startDate: "2023-12-01",
          endDate: "2023-12-05",
          visibility: "public",
        },
        el5: {
          name: "Student Body President 2023",
          status: "completed",
          type: "general",
          candidates: [
            {
              name: "Jennifer Lee",
              votes: 892,
              faculty: "Law",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Robert Martinez",
              votes: 756,
              faculty: "Medicine",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Ashley Thompson",
              votes: 534,
              faculty: "Business",
              image: "/api/placeholder/40/40",
            },
            {
              name: "Kevin O'Connor",
              votes: 298,
              faculty: "Arts",
              image: "/api/placeholder/40/40",
            },
          ],
          eligibleVoters: 3200,
          startDate: "2023-11-15",
          endDate: "2023-11-20",
          visibility: "public",
        },
      };

      // Global variables
      let resultsChart = null;
      let autoRefreshInterval = null;
      let autoRefreshEnabled = true;

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        populateElectionDropdown();
        updateStatistics();
        setupEventListeners();
        startAutoRefresh();
      });

      // Populate election dropdown based on filters
      function populateElectionDropdown() {
        const statusFilter = document.getElementById("statusFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;
        const timeFilter = document.getElementById("timeFilter").value;
        const visibilityFilter =
          document.getElementById("visibilityFilter").value;
        const searchTerm = document
          .getElementById("globalSearch")
          .value.toLowerCase();

        const electionSelect = document.getElementById("electionSelect");
        electionSelect.innerHTML =
          '<option value="">Select an election...</option>';

        Object.entries(electionData).forEach(([id, election]) => {
          let shouldInclude = true;

          // Apply filters
          if (statusFilter !== "all" && election.status !== statusFilter) {
            shouldInclude = false;
          }
          if (typeFilter && !election.type.includes(typeFilter)) {
            shouldInclude = false;
          }
          if (
            visibilityFilter !== "all" &&
            election.visibility !== visibilityFilter
          ) {
            shouldInclude = false;
          }
          if (searchTerm && !election.name.toLowerCase().includes(searchTerm)) {
            shouldInclude = false;
          }

          // Apply timeframe filter
          if (timeFilter !== "all") {
            const currentDate = new Date();
            const electionDate = new Date(election.endDate);
            const daysDifference = Math.floor(
              (currentDate - electionDate) / (1000 * 60 * 60 * 24)
            );

            if (daysDifference > parseInt(timeFilter)) {
              shouldInclude = false;
            }
          }

          if (shouldInclude) {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = `${election.name} (${
              election.status.charAt(0).toUpperCase() + election.status.slice(1)
            })`;
            electionSelect.appendChild(option);
          }
        });
      }

      // Update statistics cards
      function updateStatistics() {
        const elections = Object.values(electionData);

        const activeElections = elections.filter((e) => e.status === "ongoing");
        const completedElections = elections.filter(
          (e) => e.status === "completed"
        );

        let totalVotes = 0;
        let totalEligible = 0;

        // Include both ongoing and completed elections for total stats
        [...activeElections, ...completedElections].forEach((election) => {
          const electionVotes = election.candidates.reduce(
            (sum, candidate) => sum + candidate.votes,
            0
          );
          totalVotes += electionVotes;
          totalEligible += election.eligibleVoters;
        });

        const turnoutRate =
          totalEligible > 0
            ? Math.round((totalVotes / totalEligible) * 100)
            : 0;

        document.getElementById("totalVotes").textContent =
          totalVotes.toLocaleString();
        document.getElementById("turnoutRate").textContent = `${turnoutRate}%`;
        document.getElementById("activeElections").textContent =
          activeElections.length;
        document.getElementById("completedElections").textContent =
          completedElections.length;
      }

      // Display election results
      function displayElectionResults(electionId) {
        const election = electionData[electionId];
        if (!election) {
          document.getElementById("resultsDisplay").style.display = "none";
          return;
        }

        // Show results display
        document.getElementById("resultsDisplay").style.display = "block";

        // Update header
        document.getElementById(
          "electionTitle"
        ).textContent = `${election.name} Results`;
        document.getElementById(
          "lastUpdated"
        ).textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

        // Show/hide live indicator
        const liveIndicator = document.getElementById("liveIndicator");
        if (election.status === "ongoing") {
          liveIndicator.style.display = "inline-flex";
        } else {
          liveIndicator.style.display = "none";
        }

        // Calculate total votes
        const totalVotes = election.candidates.reduce(
          (sum, candidate) => sum + candidate.votes,
          0
        );
        const turnoutPercent =
          election.eligibleVoters > 0
            ? Math.round((totalVotes / election.eligibleVoters) * 100)
            : 0;

        // Update progress bar
        document.getElementById(
          "progressBar"
        ).style.width = `${turnoutPercent}%`;
        document.getElementById(
          "progressText"
        ).textContent = `${totalVotes.toLocaleString()} of ${election.eligibleVoters.toLocaleString()} eligible voters (${turnoutPercent}%)`;

        // Update status
        const statusText =
          election.status === "ongoing"
            ? "Election in progress"
            : election.status === "completed"
            ? "Election completed"
            : "Election upcoming";
        document.getElementById("electionStatus").textContent = statusText;

        // Update table and chart
        updateTable(election, totalVotes);
        updateChart(election, totalVotes);
      }

      // Update results table
      function updateTable(election, totalVotes) {
        const tbody = document.getElementById("resultsTableBody");
        tbody.innerHTML = "";

        if (election.candidates.length === 0 || totalVotes === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted py-4">No votes cast yet</td></tr>';
          return;
        }

        // Sort candidates by votes (descending)
        const sortedCandidates = [...election.candidates].sort(
          (a, b) => b.votes - a.votes
        );

        sortedCandidates.forEach((candidate, index) => {
          const percentage =
            totalVotes > 0
              ? ((candidate.votes / totalVotes) * 100).toFixed(1)
              : "0.0";
          const isWinner =
            index === 0 &&
            election.status === "completed" &&
            candidate.votes > 0;
          const isLeading =
            index === 0 && election.status === "ongoing" && candidate.votes > 0;

          const row = document.createElement("tr");
          row.className = "candidate-row";
          row.innerHTML = `
      <td><strong>${index + 1}</strong></td>
      <td>
        <div class="d-flex align-items-center">
          <img src="${
            candidate.image
          }" class="rounded-circle me-3" alt="Candidate" style="width: 40px; height: 40px;">
          <div>
            <strong>${candidate.name}</strong>
            <div class="text-muted small">${candidate.faculty} Faculty</div>
          </div>
          ${
            isWinner
              ? '<span class="winner-badge ms-2" style="background-color: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Winner</span>'
              : ""
          }
          ${
            isLeading
              ? '<span class="winner-badge ms-2" style="background-color: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Leading</span>'
              : ""
          }
        </div>
      </td>
      <td><strong>${candidate.votes.toLocaleString()}</strong></td>
      <td><strong>${percentage}%</strong></td>
      <td>
        ${
          isWinner
            ? '<i class="fas fa-trophy text-warning"></i> Winner'
            : isLeading
            ? '<i class="fas fa-arrow-up text-success"></i> Leading'
            : '<i class="fas fa-minus text-muted"></i> Following'
        }
      </td>
    `;
          tbody.appendChild(row);
        });
      }

      // Update pie chart
      function updateChart(election, totalVotes) {
        const ctx = document.getElementById("resultsChart").getContext("2d");

        if (resultsChart) {
          resultsChart.destroy();
        }

        if (election.candidates.length === 0 || totalVotes === 0) {
          // Clear canvas and show message
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = "16px Arial";
          ctx.fillStyle = "#6c757d";
          ctx.textAlign = "center";
          ctx.fillText(
            "No votes cast yet",
            ctx.canvas.width / 2,
            ctx.canvas.height / 2
          );

          // Clear legend
          document.getElementById("chartLegend").innerHTML = "";
          return;
        }

        const colors = [
          "#28369e",
          "#3a429b",
          "#4c51a3",
          "#5e60ab",
          "#706fb3",
          "#827ebb",
          "#948dc3",
          "#a69ccb",
          "#b8abd3",
          "#cabadb",
          "#dcc9e3",
          "#eed8eb",
        ];

        const sortedCandidates = [...election.candidates].sort(
          (a, b) => b.votes - a.votes
        );

        resultsChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: sortedCandidates.map((c) => c.name),
            datasets: [
              {
                data: sortedCandidates.map((c) => c.votes),
                backgroundColor: colors.slice(0, sortedCandidates.length),
                borderColor: "#ffffff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  generateLabels: function (chart) {
                    const data = chart.data;
                    return data.labels.map((label, index) => {
                      const votes = data.datasets[0].data[index];
                      const percentage =
                        totalVotes > 0
                          ? ((votes / totalVotes) * 100).toFixed(1)
                          : "0.0";
                      return {
                        text: `${label}: ${votes} votes (${percentage}%)`,
                        fillStyle: data.datasets[0].backgroundColor[index],
                        hidden: false,
                        index: index,
                      };
                    });
                  },
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const votes = context.raw;
                    const percentage =
                      totalVotes > 0
                        ? ((votes / totalVotes) * 100).toFixed(1)
                        : "0.0";
                    return `${context.label}: ${votes} votes (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      // Setup event listeners
      function setupEventListeners() {
        // Election selection
        document
          .getElementById("electionSelect")
          .addEventListener("change", function () {
            if (this.value) {
              displayElectionResults(this.value);
            } else {
              document.getElementById("resultsDisplay").style.display = "none";
            }
          });

        // View toggle
        document
          .getElementById("tableView")
          .addEventListener("click", function () {
            showTableView();
          });

        document
          .getElementById("chartView")
          .addEventListener("click", function () {
            showChartView();
          });

        // Filter changes
        document
          .getElementById("statusFilter")
          .addEventListener("change", populateElectionDropdown);
        document
          .getElementById("typeFilter")
          .addEventListener("change", populateElectionDropdown);
        document
          .getElementById("timeFilter")
          .addEventListener("change", populateElectionDropdown);
        document
          .getElementById("visibilityFilter")
          .addEventListener("change", populateElectionDropdown);
        document
          .getElementById("globalSearch")
          .addEventListener("input", populateElectionDropdown);

        // Refresh functionality
        document
          .getElementById("refreshResults")
          .addEventListener("click", function () {
            const selectedElection =
              document.getElementById("electionSelect").value;
            if (selectedElection) {
              simulateVoteUpdate(selectedElection);
              displayElectionResults(selectedElection);
              updateStatistics();
            }

            // Visual feedback
            this.innerHTML =
              '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }, 1000);
          });

        // Auto-refresh toggle
        document
          .getElementById("toggleAutoRefresh")
          .addEventListener("click", function () {
            autoRefreshEnabled = !autoRefreshEnabled;
            this.innerHTML = autoRefreshEnabled
              ? '<i class="fas fa-pause"></i> Auto-refresh'
              : '<i class="fas fa-play"></i> Auto-refresh';
            this.classList.toggle("btn-outline-primary");
            this.classList.toggle("btn-outline-secondary");

            if (autoRefreshEnabled) {
              startAutoRefresh();
            } else {
              if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
              }
            }
          });

        // Export functionality
        document
          .getElementById("exportResults")
          .addEventListener("click", exportResults);

        // Toggle Sidebar
        document
          .getElementById("toggleSidebar")
          .addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent this click from triggering the document click handler
            document.getElementById("sidebar").classList.toggle("active");
          });

        document.getElementById("close").addEventListener("click", function () {
          document.getElementById("sidebar").classList.remove("active");
        });

        // Close sidebar when clicking outside
        document.addEventListener("click", function (event) {
          const sidebar = document.getElementById("sidebar");
          const toggleButton = document.getElementById("toggleSidebar");

          // Check if the click is outside the sidebar and not on the toggle button
          if (
            !sidebar.contains(event.target) &&
            event.target !== toggleButton
          ) {
            sidebar.classList.remove("active");
          }
        });

        // Prevent clicks inside sidebar from closing it
        document
          .getElementById("sidebar")
          .addEventListener("click", function (e) {
            e.stopPropagation();
          });
      }

      // Show table view
      function showTableView() {
        document.getElementById("tableViewContainer").style.display = "block";
        document.getElementById("chartViewContainer").style.display = "none";
        document.getElementById("tableView").classList.add("active");
        document.getElementById("chartView").classList.remove("active");
      }

      // Show chart view
      function showChartView() {
        document.getElementById("tableViewContainer").style.display = "none";
        document.getElementById("chartViewContainer").style.display = "block";
        document.getElementById("chartView").classList.add("active");
        document.getElementById("tableView").classList.remove("active");
      }

      // Simulate vote updates for ongoing elections
      function simulateVoteUpdate(electionId) {
        const election = electionData[electionId];
        if (!election || election.status !== "ongoing") return;

        election.candidates.forEach((candidate) => {
          const increase = Math.floor(Math.random() * 5); // 0-4 new votes
          candidate.votes += increase;
        });
      }

      // Start auto-refresh
      function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);

        autoRefreshInterval = setInterval(() => {
          if (autoRefreshEnabled) {
            const selectedElection =
              document.getElementById("electionSelect").value;
            if (
              selectedElection &&
              electionData[selectedElection].status === "ongoing"
            ) {
              simulateVoteUpdate(selectedElection);
              displayElectionResults(selectedElection);
              updateStatistics();
            }
          }
        }, 10000); // Update every 10 seconds
      }

      // Export results function
      function exportResults() {
        const selectedElection =
          document.getElementById("electionSelect").value;
        if (!selectedElection) {
          alert("Please select an election to export.");
          return;
        }

        const election = electionData[selectedElection];
        const totalVotes = election.candidates.reduce(
          (sum, candidate) => sum + candidate.votes,
          0
        );
        const turnout =
          election.eligibleVoters > 0
            ? ((totalVotes / election.eligibleVoters) * 100).toFixed(1)
            : "0.0";

        // Create CSV content
        let csvContent = "Election Results Export\n";
        csvContent += `Election: ${election.name}\n`;
        csvContent += `Status: ${election.status}\n`;
        csvContent += `Total Votes: ${totalVotes}\n`;
        csvContent += `Eligible Voters: ${election.eligibleVoters}\n`;
        csvContent += `Turnout Rate: ${turnout}%\n`;
        csvContent += `Export Date: ${new Date().toLocaleString()}\n\n`;

        csvContent += "Results:\n";
        csvContent += "Rank,Candidate Name,Faculty,Votes,Percentage\n";

        const sortedCandidates = [...election.candidates].sort(
          (a, b) => b.votes - a.votes
        );

        sortedCandidates.forEach((candidate, index) => {
          const percentage =
            totalVotes > 0
              ? ((candidate.votes / totalVotes) * 100).toFixed(1)
              : "0.0";
          csvContent += `${index + 1},"${candidate.name}","${
            candidate.faculty
          }",${candidate.votes},${percentage}%\n`;
        });

        // Create download link
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `${election.name
            .replace(/[^a-z0-9]/gi, "_")
            .toLowerCase()}_results.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Show success message
        const exportBtn = document.getElementById("exportResults");
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-check me-1"></i> Exported!';
        exportBtn.classList.add("btn-success");
        exportBtn.classList.remove("btn-outline-primary");

        setTimeout(() => {
          exportBtn.innerHTML = originalText;
          exportBtn.classList.remove("btn-success");
          exportBtn.classList.add("btn-outline-primary");
        }, 2000);
      }

      // Utility function to format dates
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // Utility function to calculate time remaining
      function getTimeRemaining(endDate) {
        const now = new Date();
        const end = new Date(endDate);
        const diff = end - now;

        if (diff <= 0) return "Election ended";

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        if (days > 0) return `${days} day${days > 1 ? "s" : ""} remaining`;
        if (hours > 0) return `${hours} hour${hours > 1 ? "s" : ""} remaining`;
        return `${minutes} minute${minutes > 1 ? "s" : ""} remaining`;
      }

      // Function to handle window resize for responsive charts
      window.addEventListener("resize", function () {
        if (resultsChart) {
          resultsChart.resize();
        }
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        if (resultsChart) {
          resultsChart.destroy();
        }
      });
    </script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!api.isAuthenticated() || !api.isAdmin()) {
                window.location.href = "{% url 'login_page' %}";
                return;
            }

            await loadElections();
        });

        async function loadElections() {
            try {
                const elections = await api.getElections();
                displayElections(elections.results || elections);
            } catch (error) {
                console.error('Error loading elections:', error);
                showMessage('Failed to load elections', 'error');
            }
        }

        function displayElections(elections) {
            const electionsContainer = document.querySelector('.elections-container');
            if (!electionsContainer) return;

            electionsContainer.innerHTML = elections.map(election => `
                <div class="election-card">
                    <h5>${election.title}</h5>
                    <p>Status: ${election.status}</p>
                    <p>Start: ${new Date(election.start_date).toLocaleDateString()}</p>
                    <p>End: ${new Date(election.end_date).toLocaleDateString()}</p>
                    <button class="btn btn-primary btn-sm" onclick="viewResults(${election.id})">
                        View Results
                    </button>
                </div>
            `).join('');
        }

        async function viewResults(electionId) {
            try {
                const results = await api.getElectionResults(electionId);
                displayResults(results);
            } catch (error) {
                console.error('Error loading results:', error);
                showMessage('Failed to load results', 'error');
            }
        }

        function displayResults(results) {
            const resultsContainer = document.querySelector('.results-container');
            if (!resultsContainer) return;

            resultsContainer.innerHTML = `
                <h4>Election Results</h4>
                ${results.map(position => `
                    <div class="position-results">
                        <h5>${position.position_name}</h5>
                        ${position.candidates.map(candidate => `
                            <div class="candidate-result">
                                <span>${candidate.name}: ${candidate.votes} votes (${candidate.percentage}%)</span>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${candidate.percentage}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            `;
        }
    </script>
  </body>
</html>