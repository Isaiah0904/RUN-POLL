<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RUN POLLS | Voting</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="vote.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo-container">
        <img class="logo" src="images/Logo.png" />
        <i class="bi bi-x-lg" id="close"></i>
      </div>

      <div class="profile-container">
        <!-- Profile image container -->
        <div class="profile-image-container" id="sidebarProfileContainer">
          <!-- Profile image will be inserted here by JS -->
        </div>
        <div class="profile-name" id="userProfileName">Isaiah Durojaiye</div>
        <div class="profile-role" id="userProfileRole">Student Voter</div>
      </div>

      <!-- Sidebar Navigation -->
      <div class="sidebar-nav">
        <ul class="nav flex-column nav-main">
          <li class="nav-item">
            <a href="Voter-dashboard.html" class="nav-link">
              <i class="bi bi-grid-1x2-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link active">
              <i class="bi bi-check2-square"></i> Vote
            </a>
          </li>
          <li class="nav-item">
            <a href="Voter-guidline.html" class="nav-link">
              <i class="bi bi-journal-text"></i> Voters Guideline
            </a>
          </li>
          <li class="nav-item">
            <a href="profile-settings.html" class="nav-link">
              <i class="bi bi-gear-fill"></i> Profile Settings
            </a>
          </li>
        </ul>

        <!-- Logout button -->
        <ul class="nav flex-column nav-footer">
          <li class="nav-item">
            <a href="voter_log_in.html" class="nav-link text-danger">
              <i class="bi bi-box-arrow-right"></i> Log out
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Navbar -->
      <div class="top-navbar">
        <button class="toggle-sidebar" id="toggleSidebar">
          <i class="bi bi-list"></i>
        </button>

        <div class="search-bar position-relative">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search..."
          />
        </div>

        <div class="user-actions">
          <div class="action-icon">
            <i class="bi bi-bell"></i>
          </div>
          <div class="action-icon">
            <i class="bi bi-question-circle"></i>
          </div>
          <!-- Navbar user container -->
          <div class="navbar-user-container" id="navbarUserContainer">
            <!-- User avatar will be inserted here by JS -->
          </div>
        </div>
      </div>

      <!-- Voting Content -->
      <div class="container-fluid p-0">
        <!-- Heading -->
        <div class="row mb-4">
          <div class="col-12 text-center">
            <h3 class="text-primary fw-bold">YOU MAY NOW CAST YOUR VOTES!</h3>
          </div>
        </div>

        <!-- President Candidates -->
        <div class="candidate-section">
          <h4 class="section-header">President Student Council</h4>
          <p class="section-subheader">You can only vote for one candidate</p>

          <div class="row g-4">
            <!-- Candidate 1 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="president"
                data-candidate="1"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Felicia Monteverdi</div>
                <div class="candidate-info">Political Science • 3.9 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>

            <!-- Candidate 2 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="president"
                data-candidate="2"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Emma Alvarez Zenner</div>
                <div class="candidate-info">
                  International Relations • 3.8 GPA
                </div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>

            <!-- Candidate 3 -->
            <div class="col-md-4">
              <div
                class="candidate-card male-bg"
                data-position="president"
                data-candidate="3"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Lorenzo Agustin</div>
                <div class="candidate-info">Economics • 3.7 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vice President Candidates -->
        <div class="candidate-section">
          <h4 class="section-header">Vice President Student Council</h4>
          <p class="section-subheader">You can only vote for one candidate</p>

          <div class="row g-4">
            <!-- Candidate 1 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="vicepresident"
                data-candidate="1"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Kasey Rachel Flores</div>
                <div class="candidate-info">
                  Environmental Science • 3.7 GPA
                </div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>

            <!-- Candidate 2 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="vicepresident"
                data-candidate="2"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Candice Lokesen</div>
                <div class="candidate-info">Business Management • 3.9 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>

            <!-- Candidate 3 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="vicepresident"
                data-candidate="3"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Meagan Catalog</div>
                <div class="candidate-info">Computer Science • 3.8 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secretary Candidates -->
        <div class="candidate-section">
          <h4 class="section-header">Secretary Student Council</h4>
          <p class="section-subheader">You can only vote for one candidate</p>

          <div class="row g-4">
            <!-- Candidate 1 -->
            <div class="col-md-4">
              <div
                class="candidate-card female-bg"
                data-position="secretary"
                data-candidate="1"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Ella Cuaresma</div>
                <div class="candidate-info">Communications • 3.9 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>

            <!-- Candidate 2 -->
            <div class="col-md-4">
              <div
                class="candidate-card male-bg"
                data-position="secretary"
                data-candidate="2"
              >
                <div class="candidate-image-container">
                  <div class="default-candidate-icon">
                    <i
                      class="bi bi-person-fill"
                      style="font-size: 40px; color: #888"
                    ></i>
                  </div>
                </div>
                <div class="candidate-name">Claude Louis Tejada</div>
                <div class="candidate-info">Sociology • 3.6 GPA</div>
                <button class="vote-btn">Vote</button>
                <button class="view-btn">View Profile</button>
                <div class="edit-vote-btn">
                  <i class="bi bi-pencil-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Election status and buttons -->
        <div class="row mt-4 mb-5">
          <div class="col-12 text-center">
            <p class="election-status">Election ends in 3 days and 12 hours</p>
            <button class="reset-votes-btn btn" id="resetVotesBtn">
              Reset Selections
            </button>
            <button class="submit-vote-btn" id="submitVoteBtn">
              Submit Votes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap & Other JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Toggle Sidebar
        document
          .getElementById("toggleSidebar")
          .addEventListener("click", function () {
            document.getElementById("sidebar").classList.toggle("active");
          });

        document.getElementById("close").addEventListener("click", function () {
          document.getElementById("sidebar").classList.remove("active");
        });

        // Initialize user profile containers
        const sidebarProfileContainer = document.querySelector(
          ".profile-image-container"
        );
        const navbarUserContainer = document.querySelector(
          ".navbar-user-container"
        );

        // Load user profile data
        try {
          const user = JSON.parse(localStorage.getItem("currentUser")) || {};

          // Update profile name
          if (user.firstName && user.lastName) {
            document.getElementById(
              "userProfileName"
            ).textContent = `${user.firstName} ${user.lastName}`;
          }

          // Update profile role if exists
          if (user.role) {
            document.getElementById("userProfileRole").textContent = user.role;
          }

          // Update profile images
          updateProfileDisplays(user.profileImage);
        } catch (error) {
          console.error("Error loading user profile:", error);
          updateProfileDisplays(null);
        }

        // Function to show profile image or default user icon
        function updateProfileDisplays(imageUrl) {
          // Clear existing containers
          sidebarProfileContainer.innerHTML = "";
          navbarUserContainer.innerHTML = "";

          if (imageUrl) {
            // Sidebar profile image
            const sidebarImg = document.createElement("img");
            sidebarImg.src = imageUrl;
            sidebarImg.alt = "Profile";
            sidebarImg.className = "profile-image";
            sidebarImg.id = "userProfileImage";
            sidebarImg.style.borderRadius = "50%";
            sidebarImg.style.width = "100%";
            sidebarImg.style.height = "100%";
            sidebarImg.style.objectFit = "cover";
            sidebarProfileContainer.appendChild(sidebarImg);

            // Add edit icon to sidebar profile
            const editIcon = document.createElement("div");
            editIcon.className = "edit-icon";
            editIcon.innerHTML =
              '<i class="bi bi-pencil-fill text-white" style="font-size: 12px;"></i>';
            sidebarProfileContainer.appendChild(editIcon);

            // Navbar profile image
            const navbarImg = document.createElement("img");
            navbarImg.src = imageUrl;
            navbarImg.alt = "User";
            navbarImg.className = "user-avatar";
            navbarImg.id = "navbarUserImage";
            navbarImg.style.borderRadius = "50%";
            navbarImg.style.width = "100%";
            navbarImg.style.height = "100%";
            navbarImg.style.objectFit = "cover";
            navbarUserContainer.appendChild(navbarImg);

            // Add status indicator to navbar
            const statusIndicator = document.createElement("div");
            statusIndicator.className = "status-indicator";
            navbarUserContainer.appendChild(statusIndicator);
          } else {
            // Sidebar profile icon
            const sidebarIcon = document.createElement("div");
            sidebarIcon.className = "default-user-icon";
            sidebarIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="#888888" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
      `;
            sidebarProfileContainer.appendChild(sidebarIcon);

            // Add edit icon to sidebar profile
            const editIcon = document.createElement("div");
            editIcon.className = "edit-icon";
            editIcon.innerHTML =
              '<i class="bi bi-pencil-fill text-white" style="font-size: 12px;"></i>';
            sidebarProfileContainer.appendChild(editIcon);

            // Navbar profile icon
            const navbarIcon = document.createElement("div");
            navbarIcon.className = "default-user-icon";
            navbarIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="#888888" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
      `;
            navbarUserContainer.appendChild(navbarIcon);

            // Add status indicator to navbar
            const statusIndicator = document.createElement("div");
            statusIndicator.className = "status-indicator";
            navbarUserContainer.appendChild(statusIndicator);
          }

          // If modal is open, update modal profile image as well
          const modalProfileContainer = document.getElementById(
            "modalProfileContainer"
          );
          if (modalProfileContainer) {
            updateModalProfileImage(modalProfileContainer, imageUrl);
          }
        }

        // Function to update modal profile image
        function updateModalProfileImage(container, imageUrl) {
          container.innerHTML = "";

          if (imageUrl) {
            const img = document.createElement("img");
            img.src = imageUrl;
            img.alt = "Profile";
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "cover";
            img.style.borderRadius = "50%";
            container.appendChild(img);
          } else {
            container.innerHTML = `
        <div class="default-user-icon" style="width: 100%; height: 100%; background-color: #e9ecef; border-radius: 50%;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 80%; height: 80%; margin: 10%;">
            <path fill="#888888" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
        </div>
      `;
          }
        }

        // Helper function to show alerts
        function showAlert(message, type) {
          const alertDiv = document.createElement("div");
          alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
          alertDiv.role = "alert";
          alertDiv.style.position = "fixed";
          alertDiv.style.top = "20px";
          alertDiv.style.right = "20px";
          alertDiv.style.zIndex = "9999";
          alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

          document.body.appendChild(alertDiv);

          // Auto dismiss after 3 seconds
          setTimeout(() => {
            if (alertDiv.parentNode) {
              const bsAlert = new bootstrap.Alert(alertDiv);
              bsAlert.close();
            }
          }, 3000);
        }

        // Create profile edit modal with upload and remove functionality
        function createProfileEditModal() {
          // Modal HTML structure
          const modalHTML = `
      <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="profileEditModalLabel">View Profile Picture</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <div class="mb-4">
                <div class="position-relative d-inline-block">
                  <div id="modalProfileContainer" class="rounded-circle overflow-hidden" style="width: 150px; height: 150px;">
                    <!-- Image will be inserted here -->
                  </div>
                </div>
              </div>
              <div class="mb-4">
                <button id="modalUploadBtn" class="btn btn-success btn-sm rounded-pill px-4" style="display:none">UPLOAD</button>
                <button id="modalRemoveBtn" class="btn btn-danger btn-sm rounded-pill px-4 ms-2" style="display:none">REMOVE</button>
              </div>
              <p class="text-muted small">Go to Profile Settings to change your profile picture</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;

          // Append modal to body
          const modalDiv = document.createElement("div");
          modalDiv.innerHTML = modalHTML;
          document.body.appendChild(modalDiv);

          // Get current user data
          const user = JSON.parse(localStorage.getItem("currentUser")) || {};

          // Update modal profile container with current image or default icon
          const modalProfileContainer = document.getElementById(
            "modalProfileContainer"
          );
          updateModalProfileImage(modalProfileContainer, user.profileImage);

          // Handle upload button click in modal
          document
            .getElementById("modalUploadBtn")
            .addEventListener("click", function () {
              // Create file input element
              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.display = "none";
              document.body.appendChild(fileInput);

              // Trigger file selection
              fileInput.click();

              // Handle file selection
              fileInput.addEventListener("change", function () {
                if (this.files && this.files[0]) {
                  const reader = new FileReader();

                  reader.onload = function (e) {
                    const imageResult = e.target.result;

                    // Update modal image
                    updateModalProfileImage(modalProfileContainer, imageResult);

                    // Update profile images on page
                    updateProfileDisplays(imageResult);

                    // Store image in localStorage
                    try {
                      let user =
                        JSON.parse(localStorage.getItem("currentUser")) || {};
                      user.profileImage = imageResult;
                      localStorage.setItem("currentUser", JSON.stringify(user));

                      // Show success message
                      showAlert(
                        "Profile picture updated successfully!",
                        "success"
                      );
                    } catch (error) {
                      console.error("Error saving profile image:", error);
                      showAlert(
                        "Error saving profile image. Please try again.",
                        "danger"
                      );
                    }
                  };

                  reader.readAsDataURL(this.files[0]);
                }

                // Clean up
                document.body.removeChild(fileInput);
              });
            });

          // Handle remove button click in modal
          document
            .getElementById("modalRemoveBtn")
            .addEventListener("click", function () {
              // Update both modal and page with default icons
              updateModalProfileImage(modalProfileContainer, null);
              updateProfileDisplays(null);

              // Remove image from storage
              try {
                let user =
                  JSON.parse(localStorage.getItem("currentUser")) || {};
                delete user.profileImage;
                localStorage.setItem("currentUser", JSON.stringify(user));

                // Show success message
                showAlert("Profile picture removed successfully!", "success");
              } catch (error) {
                console.error("Error removing profile image:", error);
                showAlert(
                  "Error removing profile image. Please try again.",
                  "danger"
                );
              }
            });

          return new bootstrap.Modal(
            document.getElementById("profileEditModal")
          );
        }

        // Add profile edit functionality to both sidebar and navbar profile images
        const profileElements = [sidebarProfileContainer, navbarUserContainer];

        profileElements.forEach((element) => {
          element.style.cursor = "pointer";
          element.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Create and show the modal
            const profileModal = createProfileEditModal();
            profileModal.show();

            // Clean up when modal is hidden
            document
              .getElementById("profileEditModal")
              .addEventListener("hidden.bs.modal", function () {
                if (this.parentNode) {
                  document.body.removeChild(this.parentNode);
                }
              });
          });
        });

        // Voting functionality
        const voteButtons = document.querySelectorAll(".vote-btn");
        const viewButtons = document.querySelectorAll(".view-btn");
        const editButtons = document.querySelectorAll(".edit-vote-btn");
        const candidateCards = document.querySelectorAll(".candidate-card");
        const submitVoteBtn = document.getElementById("submitVoteBtn");
        const resetVotesBtn = document.getElementById("resetVotesBtn");

        // Track selected candidates
        const selectedCandidates = {
          president: null,
          vicepresident: null,
          secretary: null,
        };

        // Track if user has edited votes
        let hasEdited = false;

        // Format position name for display
        function formatPositionName(pos) {
          return pos
            .replace(/([A-Z])/g, " $1")
            .split(" ")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");
        }

        // Function to select a candidate
        function selectCandidate(card) {
          const position = card.getAttribute("data-position");
          const candidateId = card.getAttribute("data-candidate");
          const candidateName =
            card.querySelector(".candidate-name").textContent;

          // If user already selected this candidate, do nothing
          if (
            selectedCandidates[position] &&
            selectedCandidates[position].id === candidateId
          ) {
            return;
          }

          // Remove selection from other candidates in the same position
          document
            .querySelectorAll(`.candidate-card[data-position="${position}"]`)
            .forEach((otherCard) => {
              otherCard.classList.remove("selected");
              otherCard.querySelector(".vote-btn").textContent = "Vote";
              otherCard
                .querySelector(".vote-btn")
                .classList.remove("btn-success");
              otherCard.querySelector(".vote-btn").classList.add("vote-btn");
            });

          // Select this candidate
          card.classList.add("selected");
          const voteBtn = card.querySelector(".vote-btn");
          voteBtn.textContent = "Selected";
          voteBtn.classList.add("btn-success");

          // Update selected candidates
          selectedCandidates[position] = {
            id: candidateId,
            name: candidateName,
          };

          // Show confirmation message
          showAlert(
            `You selected ${candidateName} for ${formatPositionName(position)}`,
            "info"
          );
        }

        // Add click event for candidate cards
        candidateCards.forEach((card) => {
          card.addEventListener("click", function () {
            // Don't allow voting if user has already voted
            const user = JSON.parse(localStorage.getItem("currentUser")) || {};
            if (user.hasVoted) {
              return;
            }

            selectCandidate(this);
          });
        });

        // Add click event for vote buttons
        voteButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent the card click event

            // Trigger click on parent card
            this.closest(".candidate-card").click();
          });
        });

        // Add click event for view profile buttons
        viewButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent the card click event

            const candidateName =
              this.closest(".candidate-card").querySelector(
                ".candidate-name"
              ).textContent;
            const candidateInfo =
              this.closest(".candidate-card").querySelector(
                ".candidate-info"
              ).textContent;
            const position =
              this.closest(".candidate-card").getAttribute("data-position");

            // Show candidate profile in a modal
            const modalHtml = `
        <div class="modal fade" id="candidateProfileModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${candidateName}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="text-center mb-3">
                  <div style="width: 100px; height: 100px; margin: 0 auto;">
                    <img src="/api/placeholder/100/100" alt="${candidateName}" class="rounded-circle img-fluid border" />
                  </div>
                </div>
                <p class="text-center text-secondary">${candidateInfo}</p>
                <h6 class="mt-4">Running for: ${formatPositionName(
                  position
                )}</h6>
                <p class="mt-3">
                  <strong>Campaign Platform:</strong><br>
                  Our candidate is committed to enhancing student life through improved campus facilities, 
                  transparent governance, and more opportunities for student involvement. We will focus on 
                  creating a more inclusive environment where every student's voice matters.
                </p>
                <p>
                  <strong>Key Initiatives:</strong>
                </p>
                <ul>
                  <li>Expanding student support services</li>
                  <li>Organizing more campus activities and events</li>
                  <li>Advocating for student concerns with administration</li>
                  <li>Improving campus sustainability initiatives</li>
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary vote-for-candidate">Vote for Candidate</button>
              </div>
            </div>
          </div>
        </div>
      `;

            // Remove any existing modal
            const existingModal = document.getElementById(
              "candidateProfileModal"
            );
            if (existingModal) {
              existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML("beforeend", modalHtml);

            // Initialize modal
            const modalElement = document.getElementById(
              "candidateProfileModal"
            );
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Add event listener for vote button in modal
            document
              .querySelector(".vote-for-candidate")
              .addEventListener("click", () => {
                // Close modal
                modal.hide();

                // Select the candidate
                this.closest(".candidate-card").click();
              });
          });
        });

        // Submit votes
        if (submitVoteBtn) {
          submitVoteBtn.addEventListener("click", async function () {
            // Check if all positions have been voted for
            const positions = Object.keys(selectedCandidates);
            const unvotedPositions = positions.filter(
              (pos) => selectedCandidates[pos] === null
            );

            if (unvotedPositions.length > 0) {
              // Format position names for display
              const formattedPositions = unvotedPositions
                .map((pos) => formatPositionName(pos))
                .join(", ");

              // Show error message
              showAlert(
                `Please vote for the following positions: ${formattedPositions}`,
                "danger"
              );
            } else {
              try {
                // Prepare vote data for backend
                const voteData = {
                  election_id: currentElectionId, // This should be set when page loads
                  votes: Object.entries(selectedCandidates).map(([position, candidate]) => ({
                    position: position,
                    candidate_id: candidate.id
                  }))
                };

                // Show loading state
                submitVoteBtn.disabled = true;
                submitVoteBtn.textContent = 'Submitting Votes...';

                // Submit votes to backend
                const response = await api.castVote(voteData);

                if (response.success) {
                  // Show success modal
                  const modalHtml = `
                    <div class="modal fade" id="voteSuccessModal" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Vote Successful!</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="text-center mb-4">
                              <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                            </div>
                            <h5 class="text-center">Thank you for voting!</h5>
                            <p class="text-center">Your votes have been successfully recorded.</p>
                            
                            <div class="mt-4">
                              <h6>Your selections:</h6>
                              <ul class="list-group">
                                ${positions
                                  .map(
                                    (pos) => `
                                  <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${formatPositionName(pos)}
                                    <span class="badge bg-primary rounded-pill">${
                                      selectedCandidates[pos].name
                                    }</span>
                                  </li>
                                `
                                  )
                                  .join("")}
                              </ul>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <a href="Voter-dashboard.html" class="btn btn-primary">Return to Dashboard</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;

                  // Add modal to body
                  document.body.insertAdjacentHTML("beforeend", modalHtml);

                  // Initialize and show modal
                  const modalElement = document.getElementById("voteSuccessModal");
                  const modal = new bootstrap.Modal(modalElement);
                  modal.show();

                  // Disable all voting functionality
                  disableVoting();
                } else {
                  showAlert('Failed to submit votes. Please try again.', 'danger');
                }
              } catch (error) {
                console.error('Voting error:', error);
                showAlert('Network error. Please try again.', 'danger');
              } finally {
                // Reset button state
                submitVoteBtn.disabled = false;
                submitVoteBtn.textContent = 'Submit Votes';
              }

              // Show success message with modal
              const modalHtml = `
          <div class="modal fade" id="voteSuccessModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">Vote Successful!</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="text-center mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                  </div>
                  <h5 class="text-center">Thank you for voting!</h5>
                  <p class="text-center">Your votes have been successfully recorded.</p>
                  
                  <div class="mt-4">
                    <h6>Your selections:</h6>
                    <ul class="list-group">
                      ${positions
                        .map(
                          (pos) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          ${formatPositionName(pos)}
                          <span class="badge bg-primary rounded-pill">${
                            selectedCandidates[pos].name
                          }</span>
                        </li>
                      `
                        )
                        .join("")}
                    </ul>
                  </div>
                </div>
                <div class="modal-footer">
                  <a href="Voter-dashboard.html" class="btn btn-primary">Return to Dashboard</a>
                </div>
              </div>
            </div>
          </div>
        `;

              // Add modal to body
              document.body.insertAdjacentHTML("beforeend", modalHtml);

              // Initialize and show modal
              const modalElement = document.getElementById("voteSuccessModal");
              const modal = new bootstrap.Modal(modalElement);
              modal.show();

              // Disable vote buttons and submit button
              voteButtons.forEach((button) => {
                button.disabled = true;
              });

              viewButtons.forEach((button) => {
                button.disabled = true;
              });

              candidateCards.forEach((card) => {
                card.style.opacity = "0.7";
                card.style.cursor = "default";
                card.style.pointerEvents = "none";
              });

              submitVoteBtn.disabled = true;
            }
          });
        }

        // Reset votes functionality
        if (resetVotesBtn) {
          resetVotesBtn.addEventListener("click", function () {
            // Check if user has already voted
            const user = JSON.parse(localStorage.getItem("currentUser")) || {};
            if (user.hasVoted) {
              showAlert(
                "You have already cast your vote and cannot reset selections.",
                "warning"
              );
              return;
            }

            // Empty selectedCandidates object
            Object.keys(selectedCandidates).forEach(
              (key) => (selectedCandidates[key] = null)
            );

            // Reset UI
            candidateCards.forEach((card) => {
              card.classList.remove("selected");
              const voteBtn = card.querySelector(".vote-btn");
              voteBtn.textContent = "Vote";
              voteBtn.classList.remove("btn-success");
            });

            // Show confirmation message
            showAlert("Your selections have been reset", "info");
          });
        }

        // Check if user has already voted
        const user = JSON.parse(localStorage.getItem("currentUser")) || {};
        if (user.hasVoted && voteButtons.length > 0) {
          // Disable voting functionality
          voteButtons.forEach((button) => {
            button.disabled = true;
            button.textContent = "Already Voted";
          });

          viewButtons.forEach((button) => {
            button.disabled = true;
          });

          candidateCards.forEach((card) => {
            card.style.opacity = "0.7";
            card.style.cursor = "default";
            card.style.pointerEvents = "none";
          });

          if (submitVoteBtn) {
            submitVoteBtn.disabled = true;
            submitVoteBtn.textContent = "You have already voted";
          }

          // Show message
          showAlert(
            "You have already cast your vote for this election.",
            "info"
          );
        }

        // Countdown timer for election
        const electionStatus = document.querySelector(".election-status");
        if (electionStatus) {
          function updateCountdown() {
            // Set end date (3 days and 12 hours from now for demo)
            const now = new Date();
            const endDate = new Date(now);
            endDate.setDate(endDate.getDate() + 3);
            endDate.setHours(endDate.getHours() + 12);

            const timeLeft = endDate - now;

            if (timeLeft <= 0) {
              electionStatus.textContent = "Election has ended";
              return;
            }

            // Calculate days, hours, minutes, seconds
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
              (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            // Update countdown text
            electionStatus.textContent = `Election ends in ${days} days, ${hours} hours, ${minutes} minutes and ${seconds} seconds`;
          }

          // Update countdown every second
          updateCountdown();
          setInterval(updateCountdown, 1000);
        }

        // Search functionality
        const searchInput = document.querySelector(".search-input");
        if (searchInput) {
          searchInput.addEventListener("input", function () {
            const searchTerm = this.value.toLowerCase().trim();

            if (searchTerm.length === 0) {
              // Reset all candidates visibility
              candidateCards.forEach((card) => {
                card.closest(".col-md-4").style.display = "block";
              });
              return;
            }

            // Filter candidates
            candidateCards.forEach((card) => {
              const candidateName = card
                .querySelector(".candidate-name")
                .textContent.toLowerCase();
              const candidateInfo = card
                .querySelector(".candidate-info")
                .textContent.toLowerCase();
              const position = formatPositionName(
                card.getAttribute("data-position")
              ).toLowerCase();

              // Show or hide based on search term
              if (
                candidateName.includes(searchTerm) ||
                candidateInfo.includes(searchTerm) ||
                position.includes(searchTerm)
              ) {
                card.closest(".col-md-4").style.display = "block";
              } else {
                card.closest(".col-md-4").style.display = "none";
              }
            });
          });
        }
      });
    </script>
  </body>
</html>
