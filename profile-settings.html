<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RUN POLLS | Profile</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="profile-settings.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo-container">
        <img class="logo" src="images/Logo.png" />
        <i class="bi bi-x-lg" id="close"></i>
      </div>

      <div class="profile-container">
        <!-- Improved profile image container -->
        <div
          class="profile-image-container"
          id="sidebarProfileContainer"
          style="border-radius: 50%; width: 70px; height: 70px"
        >
          <img
            src="/api/placeholder/70/70"
            alt="Profile"
            class="profile-image"
            id="userProfileImage"
          />
          <div class="edit-icon">
            <i class="bi bi-pencil-fill text-white" style="font-size: 12px"></i>
          </div>
        </div>
        <div class="profile-name" id="userProfileName">Isaiah Durojaiye</div>
        <div class="profile-role" id="userProfileRole">Student Voter</div>
      </div>

      <!-- Sidebar Navigation with improved structure -->
      <div class="sidebar-nav">
        <ul class="nav flex-column nav-main">
          <li class="nav-item">
            <a href="Voter-dashboard.html" class="nav-link">
              <i class="bi bi-grid-1x2-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="election-page.html" class="nav-link">
              <i class="bi bi-check2-square"></i> Vote
            </a>
          </li>
          <li class="nav-item">
            <a href="Voter-guidline.html" class="nav-link">
              <i class="bi bi-journal-text"></i> Voters Guideline
            </a>
          </li>
          <li class="nav-item">
            <a href="profile-settings.html" class="nav-link active">
              <i class="bi bi-gear-fill"></i> Profile Settings
            </a>
          </li>
        </ul>

        <!-- Logout button in footer section -->
        <ul class="nav flex-column nav-footer">
          <li class="nav-item">
            <a href="Login.html" class="nav-link text-danger">
              <i class="bi bi-box-arrow-right"></i> Log out
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Navbar -->
      <div class="top-navbar">
        <button class="toggle-sidebar" id="toggleSidebar">
          <i class="bi bi-list"></i>
        </button>

        <div class="search-bar position-relative">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search..."
          />
        </div>

        <div
          class="user-actions"
          title="Notifications"
        >
          <div class="action-icon">
            <a href="notifications.html"><i class="bi bi-bell"></i></a>
          </div>
          <div
            class="action-icon"
            title="Help"
            data-bs-toggle="modal"
            data-bs-target="#helpModal"
            style="cursor: pointer"
          >
            <i class="bi bi-question-circle"></i>
          </div>
          <!-- Navbar user container with default icon -->
          <div class="navbar-user-container" id="navbarUserContainer">
            <div class="default-user-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"
                />
              </svg>
            </div>
            <div class="status-indicator"></div>
          </div>
        </div>
      </div>

      <!-- Profile Content -->
      <div class="container-fluid p-0">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="mb-4">PROFILE</h5>

                <!-- Large profile image container with default icon -->
                <div
                  class="profile-large-image-container mb-3"
                  id="profileLargeContainer"
                >
                  <div class="default-user-icon large-default-user-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                      <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"
                      />
                    </svg>
                  </div>
                  <div class="profile-image-overlay">
                    <i class="bi bi-sunglasses text-white fs-3"></i>
                  </div>
                </div>

                <div class="mb-4">
                  <button
                    class="btn btn-success btn-sm rounded-pill px-4"
                    id="uploadProfileBtn"
                  >
                    UPLOAD
                  </button>
                  <button
                    id="removeProfileBtn"
                    class="btn btn-danger btn-sm rounded-pill px-4"
                  >
                    REMOVE
                  </button>
                </div>

                <div class="mb-3">
                  <label class="form-label-sm d-block text-start"
                    >First Name</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    value="Isaiah"
                    id="firstName"
                  />
                </div>

                <div class="mb-3">
                  <label class="form-label-sm d-block text-start"
                    >Last Name</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    value="Durojaiye"
                    id="lastName"
                  />
                </div>
                <button id="saveProfileBtn" class="save-btn">Save</button>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-end mb-4">
                  <button id="edit" class="btn-sm">EDIT</button>
                </div>

                <div class="mb-3">
                  <label class="d-flex align-items-center mb-1">
                    <i class="bi bi-person-badge me-2 text-primary"></i>
                    <span class="text-muted small">Student ID</span>
                  </label>
                  <div class="info-container" id="studentIdInfo">
                    RUN/CMP/22/13041
                  </div>
                </div>

                <div class="mb-3">
                  <label class="d-flex align-items-center mb-1">
                    <i class="bi bi-calendar me-2 text-primary"></i>
                    <span class="text-muted small">Date of Birth</span>
                  </label>
                  <div class="info-container" id="birthdayInfo">
                    January 1, 2000
                  </div>
                </div>

                <div class="mb-3">
                  <label class="d-flex align-items-center mb-1">
                    <i class="bi bi-telephone me-2 text-primary"></i>
                    <span class="text-muted small">Phone</span>
                  </label>
                  <div class="info-container" id="phoneInfo">
                    +234 802 960 0743
                  </div>
                </div>

                <div class="mb-3">
                  <label class="d-flex align-items-center mb-1">
                    <i class="bi bi-envelope me-2 text-primary"></i>
                    <span class="text-muted small">Email</span>
                  </label>
                  <div class="info-container" id="emailInfo">
                    isaiahdurojaiye9@gmail.com
                  </div>
                </div>

                <div class="mb-3">
                  <label class="d-flex align-items-center mb-1">
                    <i class="bi bi-building me-2 text-primary"></i>
                    <span class="text-muted small">Department</span>
                  </label>
                  <div class="info-container" id="departmentInfo">
                    Computer Science
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div
      class="modal fade help-modal"
      id="helpModal"
      tabindex="-1"
      aria-labelledby="helpModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5
              class="modal-title d-flex align-items-center"
              id="helpModalLabel"
            >
              <i class="bi bi-headset me-2"></i>
              Need Help? We're Here for You!
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Contact Methods -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="bi bi-telephone-fill me-2"></i>Contact Our Support
                Team
              </h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card contact-card p-3 text-center">
                    <div class="contact-icon phone-icon mx-auto">
                      <i class="bi bi-telephone-fill"></i>
                    </div>
                    <h6 class="fw-bold">Phone Support</h6>
                    <p class="text-muted mb-2">
                      Call us directly for immediate assistance
                    </p>
                    <p class="fw-bold text-success mb-0">+234 802 960 0743</p>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card contact-card p-3 text-center">
                    <div class="contact-icon email-icon mx-auto">
                      <i class="bi bi-envelope-fill"></i>
                    </div>
                    <h6 class="fw-bold">Email Support</h6>
                    <p class="text-muted mb-2">
                      Send us detailed questions anytime
                    </p>
                    <p class="fw-bold text-primary mb-0">
                      isaiahdurojaiye9@gmail.com
                    </p>
                  </div>
                </div>

            <!-- Emergency Contact -->
            <div class="alert alert-warning mb-4">
              <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Emergency
                Support
              </h6>
              <p class="mb-1">
                For urgent election-related issues during voting periods:
              </p>
              <p class="mb-0">
                <strong>Emergency Hotline:</strong> +234 805 987 6543
              </p>
              <small>Available 24/7 during active election periods only</small>
            </div>

            <!-- FAQ Section -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="bi bi-question-circle-fill me-2"></i>Frequently Asked
                Questions
              </h6>
              <div class="faq-item">
                <div class="faq-question">How do I reset my password?</div>
                <div class="faq-answer">
                  Click on "Forgot Password" on the login page and follow the
                  instructions sent to your registered email.
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  Can I change my vote after submitting?
                </div>
                <div class="faq-answer">
                  No, votes are final once submitted. Please review your choices
                  carefully before confirming.
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  What if I'm having trouble logging in?
                </div>
                <div class="faq-answer">
                  Ensure you're using your correct Student ID and password.
                  Clear your browser cache or try a different browser. If issues
                  persist, contact support.
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  How do I update my profile information?
                </div>
                <div class="faq-answer">
                  You can update your profile from the Profile Settings page.
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap & Other JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
       // Help Modal Implementation
document.addEventListener("DOMContentLoaded", function () {
  // Initialize help modal
  const helpModal = new bootstrap.Modal(document.getElementById("helpModal"));
  
  // Get help icon - it's in the user-actions div with question-circle class
  const helpIcon = document.querySelector('.action-icon[title="Help"]');
  
  // Help icon click handler
  if (helpIcon) {
    helpIcon.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      console.log("Help icon clicked");
      helpModal.show();
    });
    
    // Add pointer cursor to help icon
    helpIcon.style.cursor = "pointer";
  }

  // Additional event handlers for modal
  const helpModalElement = document.getElementById("helpModal");
  
  if (helpModalElement) {
    // Modal shown event
    helpModalElement.addEventListener("shown.bs.modal", function () {
      console.log("Help modal opened");
    });

    // Modal hidden event
    helpModalElement.addEventListener("hidden.bs.modal", function () {
      console.log("Help modal closed");
    });

    // Handle ESC key press to close modal
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && helpModalElement.classList.contains("show")) {
        helpModal.hide();
      }
    });
  }

  // FAQ accordion functionality (if you want expandable FAQ items)
  const faqItems = document.querySelectorAll('.faq-item');
  
  faqItems.forEach(item => {
    const question = item.querySelector('.faq-question');
    const answer = item.querySelector('.faq-answer');
    
    if (question && answer) {
      // Initially hide answers
      answer.style.display = 'none';
      question.style.cursor = 'pointer';
      
      // Add click handler to questions
      question.addEventListener('click', function() {
        const isVisible = answer.style.display === 'block';
        
        // Hide all other answers first
        faqItems.forEach(otherItem => {
          const otherAnswer = otherItem.querySelector('.faq-answer');
          if (otherAnswer && otherAnswer !== answer) {
            otherAnswer.style.display = 'none';
            otherItem.querySelector('.faq-question').classList.remove('active');
          }
        });
        
        // Toggle current answer
        if (isVisible) {
          answer.style.display = 'none';
          question.classList.remove('active');
        } else {
          answer.style.display = 'block';
          question.classList.add('active');
        }
      });
    }
  });

  // Contact card click handlers (optional - for better UX)
  const phoneCard = document.querySelector('.contact-card .phone-icon').closest('.contact-card');
  const emailCard = document.querySelector('.contact-card .email-icon').closest('.contact-card');
  
  if (phoneCard) {
    phoneCard.addEventListener('click', function() {
      const phoneNumber = this.querySelector('.text-success').textContent;
      window.location.href = `tel:${phoneNumber}`;
    });
    phoneCard.style.cursor = 'pointer';
  }
  
  if (emailCard) {
    emailCard.addEventListener('click', function() {
      const email = this.querySelector('.text-primary').textContent;
      window.location.href = `mailto:${email}`;
    });
    emailCard.style.cursor = 'pointer';
  }

  // Initialize tooltips for the help section
  const tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  console.log("Help modal functionality initialized");
});

// Alternative method if the above doesn't work due to timing issues
function initializeHelpModal() {
  const helpModal = new bootstrap.Modal(document.getElementById("helpModal"));
  const helpIcon = document.querySelector('.action-icon[title="Help"]');
  
  if (helpIcon) {
    helpIcon.onclick = function(e) {
      e.preventDefault();
      helpModal.show();
    };
  }
}

      document.addEventListener("DOMContentLoaded", function () {
        // Toggle Sidebar
        document
          .getElementById("toggleSidebar")
          .addEventListener("click", function () {
            document.getElementById("sidebar").classList.toggle("active");
          });
        document.getElementById("close").addEventListener("click", function () {
          document.getElementById("sidebar").classList.remove("active");
        });

        // Initialize all profile containers
        let profileLargeContainer = document.getElementById(
          "profileLargeContainer"
        );
        const sidebarProfileContainer = document.querySelector(
          ".profile-image-container"
        );
        const navbarUserContainer = document.querySelector(
          ".navbar-user-container"
        );

        // Temporary storage for profile image changes before saving
        let tempProfileImage = null;

        // Load user profile data including image
        try {
          const user = JSON.parse(localStorage.getItem("currentUser")) || {};

          // Update profile name
          if (user.firstName && user.lastName) {
            document.getElementById(
              "userProfileName"
            ).textContent = `${user.firstName} ${user.lastName}`;
            // Update welcome message if it exists
            const welcomeHeading = document.querySelector("h2");
            if (
              welcomeHeading &&
              welcomeHeading.textContent.includes("Hello")
            ) {
              welcomeHeading.textContent = `Hello, ${user.firstName}!`;
            }
          }

          // Update profile role if exists
          if (user.role) {
            document.getElementById("userProfileRole").textContent = user.role;
          }

          // Update profile images
          updateProfileDisplays(user.profileImage);

          // Initialize the temporary image with the current one
          tempProfileImage = user.profileImage;

          // Update the main profile image in the profile page
          updateMainProfileImage(user.profileImage);
        } catch (error) {
          console.error("Error loading user profile:", error);
          updateProfileDisplays(null);
          updateMainProfileImage(null);
        }

        // Function to show profile image or default user icon for sidebar and navbar
        function updateProfileDisplays(imageUrl) {
          // Clear existing sidebar container
          sidebarProfileContainer.innerHTML = "";
          navbarUserContainer.innerHTML = "";

          if (imageUrl) {
            // Sidebar profile image
            const sidebarImg = document.createElement("img");
            sidebarImg.src = imageUrl;
            sidebarImg.alt = "Profile";
            sidebarImg.className = "profile-image";
            sidebarImg.id = "userProfileImage";
            sidebarImg.style.borderRadius = "50%";
            sidebarImg.style.width = "100%";
            sidebarImg.style.height = "100%";
            sidebarImg.style.objectFit = "cover";
            sidebarProfileContainer.appendChild(sidebarImg);

            // Add edit icon to sidebar profile
            const editIcon = document.createElement("div");
            editIcon.className = "edit-icon";
            editIcon.innerHTML =
              '<i class="bi bi-pencil-fill text-white" style="font-size: 12px;"></i>';
            sidebarProfileContainer.appendChild(editIcon);

            // Navbar profile image
            const navbarImg = document.createElement("img");
            navbarImg.src = imageUrl;
            navbarImg.alt = "User";
            navbarImg.className = "user-avatar";
            navbarImg.id = "navbarUserImage";
            navbarImg.style.borderRadius = "50%";
            navbarImg.style.width = "100%";
            navbarImg.style.height = "100%";
            navbarImg.style.objectFit = "cover";
            navbarUserContainer.appendChild(navbarImg);

            // Add status indicator to navbar
            const statusIndicator = document.createElement("div");
            statusIndicator.className = "status-indicator";
            navbarUserContainer.appendChild(statusIndicator);
          } else {
            // Sidebar profile icon
            const sidebarIcon = document.createElement("div");
            sidebarIcon.className = "default-user-icon";
            sidebarIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
      `;
            sidebarProfileContainer.appendChild(sidebarIcon);

            // Add edit icon to sidebar profile
            const editIcon = document.createElement("div");
            editIcon.className = "edit-icon";
            editIcon.innerHTML =
              '<i class="bi bi-pencil-fill text-white" style="font-size: 12px;"></i>';
            sidebarProfileContainer.appendChild(editIcon);

            // Navbar profile icon
            const navbarIcon = document.createElement("div");
            navbarIcon.className = "default-user-icon";
            navbarIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
      `;
            navbarUserContainer.appendChild(navbarIcon);

            // Add status indicator to navbar
            const statusIndicator = document.createElement("div");
            statusIndicator.className = "status-indicator";
            navbarUserContainer.appendChild(statusIndicator);
          }
        }

        // Function to update just the main profile image in the profile page
        function updateMainProfileImage(imageUrl) {
          if (profileLargeContainer) {
            profileLargeContainer.innerHTML = "";

            if (imageUrl) {
              const largeImg = document.createElement("img");
              largeImg.src = imageUrl;
              largeImg.alt = "Profile";
              largeImg.className = "profile-large-image";
              largeImg.id = "largeProfileImage";
              largeImg.style.borderRadius = "50%";
              largeImg.style.width = "100%";
              largeImg.style.height = "100%";
              largeImg.style.objectFit = "cover";
              profileLargeContainer.appendChild(largeImg);

              // Add the overlay for large profile
              const overlay = document.createElement("div");
              overlay.className = "profile-image-overlay";
              overlay.innerHTML =
                '<i class="bi bi-sunglasses text-white fs-3"></i>';
              profileLargeContainer.appendChild(overlay);
            } else {
              const largeIcon = document.createElement("div");
              largeIcon.className = "default-user-icon large-default-user-icon";
              largeIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
        `;
              profileLargeContainer.appendChild(largeIcon);

              // Add the overlay for large profile
              const overlay = document.createElement("div");
              overlay.className = "profile-image-overlay";
              overlay.innerHTML =
                '<i class="bi bi-sunglasses text-white fs-3"></i>';
              profileLargeContainer.appendChild(overlay);
            }
          }
        }

        // Helper function to show alerts
        function showAlert(message, type) {
          const alertDiv = document.createElement("div");
          alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
          alertDiv.role = "alert";
          alertDiv.style.position = "fixed";
          alertDiv.style.top = "20px";
          alertDiv.style.right = "20px";
          alertDiv.style.zIndex = "9999";
          alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

          document.body.appendChild(alertDiv);

          // Auto dismiss after 3 seconds
          setTimeout(() => {
            if (alertDiv.parentNode) {
              const bsAlert = new bootstrap.Alert(alertDiv);
              bsAlert.close();
            }
          }, 3000);
        }

        // Handle upload button click (only updates the main profile image)
        const uploadProfileBtn = document.getElementById("uploadProfileBtn");
        if (uploadProfileBtn) {
          uploadProfileBtn.addEventListener("click", function () {
            // Create file input element
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = "image/*";
            fileInput.style.display = "none";
            document.body.appendChild(fileInput);

            // Trigger file selection
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener("change", function () {
              if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                  const imageResult = e.target.result;

                  // Update only the main profile image
                  updateMainProfileImage(imageResult);

                  // Store in temporary variable until save
                  tempProfileImage = imageResult;
                };

                reader.readAsDataURL(this.files[0]);
              }

              // Clean up
              document.body.removeChild(fileInput);
            });
          });
        }

        // Handle remove button click (only removes from main profile image)
        const removeProfileBtn = document.getElementById("removeProfileBtn");
        if (removeProfileBtn) {
          removeProfileBtn.addEventListener("click", function () {
            // Only update the main profile image
            updateMainProfileImage(null);

            // Store in temporary variable until save
            tempProfileImage = null;
          });
        }

        // Add event listener for save profile button
        const saveProfileBtn = document.getElementById("saveProfileBtn");
        if (saveProfileBtn) {
          saveProfileBtn.addEventListener("click", function () {
            // Get current user data
            let user = JSON.parse(localStorage.getItem("currentUser")) || {};

            // Update user data with current input values and temporary profile image
            user.firstName = document.getElementById("firstName").value.trim();
            user.lastName = document.getElementById("lastName").value.trim();
            user.profileImage = tempProfileImage; // Use the temporary stored image

            // Update profile name display throughout the interface
            document.getElementById(
              "userProfileName"
            ).textContent = `${user.firstName} ${user.lastName}`;

            // Save updated user data
            localStorage.setItem("currentUser", JSON.stringify(user));

            // Now update all profile displays with the saved image
            updateProfileDisplays(tempProfileImage);

            // Show success message
            showAlert("Profile saved successfully!", "success");
          });
        }

        // Add click event listeners for sidebar and navbar profile images
        const profileElements = [
          sidebarProfileContainer,
          navbarUserContainer,
          ...document.querySelectorAll(".edit-icon"),
        ];

        if (profileLargeContainer) {
          profileElements.push(profileLargeContainer);
        }

        profileElements.forEach((element) => {
          element.style.cursor = "pointer";
          element.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Create and show the profile edit modal
            const profileModal = createProfileEditModal();
            profileModal.show();

            // Clean up when modal is hidden
            document
              .getElementById("profileEditModal")
              .addEventListener("hidden.bs.modal", function () {
                if (this.parentNode) {
                  document.body.removeChild(this.parentNode);
                }
              });
          });
        });

        // Create profile edit modal for the dashboard
        function createProfileEditModal() {
          // Modal HTML structure
          const modalHTML = `
      <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="profileEditModalLabel">Edit Profile Picture</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <div class="mb-4">
                <div class="position-relative d-inline-block">
                  <div id="modalProfileContainer" class="rounded-circle overflow-hidden" style="width: 150px; height: 150px;">
                    <!-- Image will be inserted here -->
                  </div>
                </div>
              </div>
              <div class="mb-4">
                <button id="modalUploadBtn" class="btn btn-success btn-sm rounded-pill px-4">UPLOAD</button>
                <button id="modalRemoveBtn" class="btn btn-danger btn-sm rounded-pill px-4 ms-2">REMOVE</button>
              </div>
              <p class="text-muted small">Click upload to select a new profile picture</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="modalSaveBtn">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    `;

          // Append modal to body
          const modalDiv = document.createElement("div");
          modalDiv.innerHTML = modalHTML;
          document.body.appendChild(modalDiv);

          // Get current user data
          const user = JSON.parse(localStorage.getItem("currentUser")) || {};

          // Set up a temporary variable for changes in the modal
          let modalTempImage = user.profileImage;

          // Update modal profile container with current image or default icon
          const modalProfileContainer = document.getElementById(
            "modalProfileContainer"
          );
          updateModalProfileImage(modalProfileContainer, modalTempImage);

          // Handle upload button click in modal
          document
            .getElementById("modalUploadBtn")
            .addEventListener("click", function () {
              // Create file input element
              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.display = "none";
              document.body.appendChild(fileInput);

              // Trigger file selection
              fileInput.click();

              // Handle file selection
              fileInput.addEventListener("change", function () {
                if (this.files && this.files[0]) {
                  const reader = new FileReader();

                  reader.onload = function (e) {
                    const imageResult = e.target.result;

                    // Only update the modal image
                    updateModalProfileImage(modalProfileContainer, imageResult);

                    // Store in modal temporary variable
                    modalTempImage = imageResult;
                  };

                  reader.readAsDataURL(this.files[0]);
                }

                // Clean up
                document.body.removeChild(fileInput);
              });
            });

          // Handle remove button click in modal
          document
            .getElementById("modalRemoveBtn")
            .addEventListener("click", function () {
              // Only update the modal display
              updateModalProfileImage(modalProfileContainer, null);

              // Store in modal temporary variable
              modalTempImage = null;
            });

          // Handle save button click in modal
          document
            .getElementById("modalSaveBtn")
            .addEventListener("click", function () {
              // Update user data with temporary image from modal
              try {
                let user =
                  JSON.parse(localStorage.getItem("currentUser")) || {};
                user.profileImage = modalTempImage;
                localStorage.setItem("currentUser", JSON.stringify(user));

                // Update all profile displays with the new image
                updateProfileDisplays(modalTempImage);
                updateMainProfileImage(modalTempImage);

                // Update the temporary variable for the main page
                tempProfileImage = modalTempImage;

                // Close the modal
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("profileEditModal")
                );
                modal.hide();

                // Show success message
                showAlert("Profile picture updated successfully!", "success");
              } catch (error) {
                console.error("Error saving profile image:", error);
                showAlert(
                  "Error saving profile image. Please try again.",
                  "danger"
                );
              }
            });

          // Function to update modal profile image
          function updateModalProfileImage(container, imageUrl) {
            container.innerHTML = "";

            if (imageUrl) {
              const img = document.createElement("img");
              img.src = imageUrl;
              img.alt = "Profile";
              img.style.width = "100%";
              img.style.height = "100%";
              img.style.objectFit = "cover";
              img.style.borderRadius = "50%";
              container.appendChild(img);
            } else {
              container.innerHTML = `
          <div class="default-user-icon" style="width: 100%; height: 100%; background-color: #e9ecef; border-radius: 50%;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 80%; height: 80%; margin: 10%;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          </div>
        `;
            }
          }

          return new bootstrap.Modal(
            document.getElementById("profileEditModal")
          );
        }

        // Get the edit button element for personal info
        const editButton = document.getElementById("edit");
        if (editButton) {
          // Get all the info containers
          const studentIdInfo = document.getElementById("studentIdInfo");
          const birthdayInfo = document.getElementById("birthdayInfo");
          const phoneInfo = document.getElementById("phoneInfo");
          const emailInfo = document.getElementById("emailInfo");
          const departmentInfo = document.getElementById("departmentInfo");

          // Flag to track if we're in edit mode
          let isEditing = false;

          // Store original values to allow cancellation
          let originalValues = {};

          // Add click event listener to the edit button
          editButton.addEventListener("click", function () {
            if (!isEditing) {
              // Enter edit mode
              enterEditMode();
            } else {
              // Save changes
              saveChanges();
            }
          });

          // Function to enter edit mode
          function enterEditMode() {
            isEditing = true;
            editButton.textContent = "SAVE";
            editButton.classList.add("btn-success");

            // Store original values before editing
            originalValues = {
              studentId: studentIdInfo.textContent.trim(),
              birthday: birthdayInfo.textContent.trim(),
              phone: phoneInfo.textContent.trim(),
              email: emailInfo.textContent.trim(),
              department: departmentInfo.textContent.trim(),
            };

            // Replace each info container with an input field
            replaceWithInput(
              studentIdInfo,
              "studentId",
              originalValues.studentId
            );
            replaceWithInput(birthdayInfo, "birthday", originalValues.birthday);
            replaceWithInput(phoneInfo, "phone", originalValues.phone);
            replaceWithInput(emailInfo, "email", originalValues.email);
            replaceWithInput(
              departmentInfo,
              "department",
              originalValues.department
            );

            const cancelButton = document.createElement("button");
            cancelButton.id = "cancel";
            cancelButton.textContent = "CANCEL";

            // Style the cancel button to be red
            cancelButton.className = "btn-sm ms-2 text-white";
            cancelButton.style.backgroundColor = "#dc3545"; // Bootstrap danger red
            cancelButton.style.border = "none";
            cancelButton.style.borderRadius = "60px";
            cancelButton.style.padding = "0.25rem 0.5rem";
            cancelButton.addEventListener("click", cancelEditing);

            // Insert the cancel button after the edit button
            editButton.parentNode.insertBefore(
              cancelButton,
              editButton.nextSibling
            );
          }

          // Function to replace info container with input field
          function replaceWithInput(element, fieldName, value) {
            // Create input field
            const input = document.createElement("input");
            input.type = fieldName === "email" ? "email" : "text";
            input.className = "form-control";
            input.value = value;
            input.dataset.field = fieldName; // Store field name for reference

            // Special handling for birthday field to add date picker
            if (fieldName === "birthday") {
              input.type = "date";

              // Try to convert the displayed date format to YYYY-MM-DD for the input
              try {
                const dateParts = value.split(" ");
                const monthNames = [
                  "January",
                  "February",
                  "March",
                  "April",
                  "May",
                  "June",
                  "July",
                  "August",
                  "September",
                  "October",
                  "November",
                  "December",
                ];

                const month =
                  monthNames.indexOf(dateParts[0].replace(",", "")) + 1;
                const day = parseInt(dateParts[1].replace(",", ""));
                const year = parseInt(dateParts[2]);

                // Format date as YYYY-MM-DD
                const formattedMonth = month < 10 ? `0${month}` : month;
                const formattedDay = day < 10 ? `0${day}` : day;
                input.value = `${year}-${formattedMonth}-${formattedDay}`;
              } catch (error) {
                console.error("Error parsing date:", error);
                // Fallback to empty value if parsing fails
                input.value = "";
              }
            }

            // Replace the element with the input
            element.innerHTML = "";
            element.appendChild(input);
          }

          // Function to save changes
          function saveChanges() {
            isEditing = false;
            editButton.textContent = "EDIT";
            editButton.classList.remove("btn-success");

            // Get current user data
            let user = JSON.parse(localStorage.getItem("currentUser")) || {};

            // Get all input fields
            const inputs = document.querySelectorAll(".info-container input");

            // Update user data with input values
            inputs.forEach((input) => {
              const field = input.dataset.field;
              let value = input.value.trim();

              // Special handling for date field
              if (field === "birthday" && value) {
                // Convert YYYY-MM-DD to Month Day, Year
                const date = new Date(value);
                const options = {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                };
                value = date.toLocaleDateString("en-US", options);
              }

              // Update user object
              user[field] = value;

              // Update display
              const container = input.parentNode;
              container.innerHTML = value;
            });

            // Save updated user data
            localStorage.setItem("currentUser", JSON.stringify(user));

            // Remove cancel button
            const cancelButton = document.getElementById("cancel");
            if (cancelButton) {
              cancelButton.remove();
            }

            // Show success message
            showAlert("Profile updated successfully!", "success");
          }

          // Function to cancel editing
          function cancelEditing() {
            isEditing = false;
            editButton.textContent = "EDIT";
            editButton.classList.remove("btn-success");

            // Restore original values
            studentIdInfo.innerHTML = originalValues.studentId;
            birthdayInfo.innerHTML = originalValues.birthday;
            phoneInfo.innerHTML = originalValues.phone;
            emailInfo.innerHTML = originalValues.email;
            departmentInfo.innerHTML = originalValues.department;

            // Remove cancel button
            document.getElementById("cancel").remove();
          }
        }

        // Initialize user data if not exists
        function loadUserData() {
          try {
            const user = JSON.parse(localStorage.getItem("currentUser"));
            if (!user) {
              // If no user exists, create default user
              const defaultUser = {
                firstName: "Isaiah",
                lastName: "Durojaiye",
                studentId: "RUN/CMP/22/13041",
                birthday: "January 1, 2000",
                phone: "+234 802 960 0743",
                email: "isaiahdurojaiye9@gmail.com",
                department: "Computer Science",
                role: "Student Voter",
              };
              localStorage.setItem("currentUser", JSON.stringify(defaultUser));
            }
          } catch (error) {
            console.error("Error loading user data:", error);
          }
        }
      });
    </script>
  </body>
</html>
